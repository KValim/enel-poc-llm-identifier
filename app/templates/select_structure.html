<!DOCTYPE html>
<html>
<head>
    <title>Seleção de Estruturas</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/static/css/style.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
    <div class="container">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-success" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Page Header -->
        <h1 class="text-center my-4">Estruturas do Projeto: {{ project }}</h1>

        <form method="post" id="side-selection-form">
            <div class="mb-3">
                <label for="side" class="form-label">Escolha o lado para começar a validação:</label>
                <select name="side" id="side" class="form-select" required onchange="updateMap()">
                    <option value="A" selected>Lado A - Inicio na {{ lado_a.name }}</option>
                    <option value="B">Lado B - Inicio na {{ lado_b.name }}</option>
                </select>
            </div>
            <button type="submit" name="start_validation" class="btn btn-primary">Começar Validação</button>
        </form>

        <!-- Map Section -->
        <h2 class="text-center my-4">Mapa das Estruturas</h2>
        <div id="map" style="height: 500px;"></div>

        <!-- Back to Home Link -->
        <a href="/" class="btn btn-link mt-4">Voltar para Seleção de Projetos</a>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Custom JavaScript -->
    <script>
        const structures = {{ structure_map_data|tojson }};
        const ladoA = {{ lado_a|tojson }};
        const ladoB = {{ lado_b|tojson }};
        const project = "{{ project }}";
        let map;
        let bounds = [];
        let linesLayer = null;

        // Initialize the map with a default center
        function initializeMap() {
            map = L.map('map').setView([-23.55052, -46.633308], 13);

            // Set up the OSM layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add markers for each structure
            structures.forEach(structure => {
                const lat = structure.latitude;
                const lon = structure.longitude;
                const name = structure.name;
                const marker = L.marker([lat, lon]).addTo(map)
                    .bindPopup(`<b>${name}</b><br>Latitude: ${lat}<br>Longitude: ${lon}`);
                bounds.push([lat, lon]);
            });

            // Get user location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;
                    const userMarker = L.marker([userLat, userLon], {
                        icon: L.icon({
                            iconUrl: 'https://cdn4.iconfinder.com/data/icons/man/100/man-10-1024.png', // URL do novo ícone
                            iconSize: [50, 50], // Ajuste o tamanho do ícone conforme necessário
                            iconAnchor: [15, 50] // Ajuste o ponto de ancoragem conforme necessário
                        })
                    }).addTo(map)
                        .bindPopup(`<b>Sua localização</b><br>Latitude: ${userLat}<br>Longitude: ${userLon}`);
                    
                    bounds.push([userLat, userLon]);
                    map.setView([userLat, userLon], 13);
                    addLines();
                    map.fitBounds(bounds);
                }, () => {
                    alert("Não foi possível obter sua localização.");
                    addLines();
                    map.fitBounds(bounds);
                });
            } else {
                alert("Geolocalização não é suportada pelo seu navegador.");
                addLines();
                map.fitBounds(bounds);
            }
        }

        // Function to add lines for Lado A and Lado B
        function addLines() {
            if (linesLayer) {
                map.removeLayer(linesLayer);
            }

            linesLayer = L.layerGroup();

            const lineA = L.polyline([
                [ladoA.latitude, ladoA.longitude],
                [ladoA.latitude + 0.0005, ladoA.longitude]
            ], {color: 'red'}).addTo(linesLayer);

            const lineB = L.polyline([
                [ladoB.latitude, ladoB.longitude],
                [ladoB.latitude + 0.0005, ladoB.longitude]
            ], {color: 'red'}).addTo(linesLayer);

            L.marker([ladoA.latitude + 0.0007, ladoA.longitude], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: '<div style="color: red; font-size: 16px; text-align: center;">Lado A</div>',
                    iconSize: [60, 40],
                    iconAnchor: [30, -10]
                })
            }).addTo(linesLayer);

            L.marker([ladoB.latitude + 0.0007, ladoB.longitude], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: '<div style="color: red; font-size: 16px; text-align: center;">Lado B</div>',
                    iconSize: [60, 40],
                    iconAnchor: [30, -10]
                })
            }).addTo(linesLayer);

            linesLayer.addTo(map);
        }

        function updateMap() {
            addLines();
        }

        initializeMap();
    </script>
</body>
</html>